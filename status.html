<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenWrt 构建状态监控</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2c3e50',
                        success: '#2ecc71',
                        pending: '#f39c12',
                        failure: '#e74c3c',
                        cancelled: '#95a5a6',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .status-pulse {
                animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            }
            .card-hover {
                transition: transform 0.3s ease, box-shadow 0.3s ease;
            }
            .card-hover:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            }
            .lang-btn {
                transition: all 0.2s ease;
            }
            .lang-btn.active {
                background-color: #2c3e50;
                color: white;
            }
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans text-gray-800 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-5xl">
        <header class="mb-10 text-center">
            <div class="flex justify-end mb-4">
                <div class="flex space-x-2">
                    <button id="lang-zh" class="lang-btn active px-3 py-1 rounded text-sm border border-primary/30">中文</button>
                    <button id="lang-en" class="lang-btn px-3 py-1 rounded text-sm border border-primary/30">English</button>
                </div>
            </div>
            
            <h1 class="text-[clamp(1.8rem,4vw,2.5rem)] font-bold text-primary mb-2" data-i18n="title">
                <i class="fa fa-github mr-3"></i>OpenWrt 构建状态监控
            </h1>
            <p class="text-gray-600" data-i18n="subtitle">实时跟踪工作流构建结果</p>
            <div class="mt-4 flex justify-center items-center space-x-2 text-sm text-gray-500">
                <span id="last-update" data-i18n="lastUpdate">最后更新：从未</span>
                <span class="inline-block w-2 h-2 rounded-full bg-gray-400"></span>
                <span id="status-indicator" data-i18n="waiting">等待开始...</span>
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <!-- 工作流状态卡片将通过JS动态生成 -->
        </div>

        <div class="bg-white rounded-lg shadow p-4 mb-8">
            <h2 class="text-lg font-semibold mb-3 flex items-center" data-i18n="historyTitle">
                <i class="fa fa-history text-primary mr-2"></i>构建历史记录
            </h2>
            <div id="history-container" class="space-y-2 max-h-60 overflow-y-auto">
                <p class="text-gray-500 italic text-center py-4" data-i18n="noHistory">暂无历史记录</p>
            </div>
        </div>

        <footer class="text-center text-gray-500 text-sm py-4" data-i18n="footer">
            <p>数据来源: GitHub API | 刷新间隔: 180秒</p>
        </footer>
    </div>

    <script>
        // 语言翻译映射
        const translations = {
            zh: {
                title: "OpenWrt 构建状态监控",
                subtitle: "实时跟踪工作流构建结果",
                lastUpdate: "最后更新：从未",
                waiting: "等待开始...",
                initializing: "正在初始化工作流...",
                initFailed: "初始化失败",
                partialInitFailed: "部分工作流初始化失败",
                initCompleted: "工作流初始化完成",
                updating: "正在更新状态...",
                updateCompleted: "更新完成",
                updateFailed: "更新失败",
                viewDetails: "查看详情",
                historyTitle: "构建历史记录",
                noHistory: "暂无历史记录",
                footer: "数据来源: GitHub API | 刷新间隔: 60秒",
                status: {
                    queued: "排队中",
                    in_progress: "构建中",
                    completed: {
                        success: "成功",
                        failure: "失败",
                        cancelled: "已取消",
                        neutral: "中性",
                        default: "未知"
                    },
                    no_runs: "无运行记录",
                    error: "获取数据失败",
                    unknown: "未知状态"
                },
                time: {
                    justNow: "刚刚",
                    minutesAgo: "{0}分钟前",
                    hoursAgo: "{0}小时前",
                    daysAgo: "{0}天前"
                }
            },
            en: {
                title: "OpenWrt Build Status Monitor",
                subtitle: "Real-time tracking of key workflow results",
                lastUpdate: "Last update: Never",
                waiting: "Waiting to start...",
                initializing: "Initializing workflows...",
                initFailed: "Initialization failed",
                partialInitFailed: "Partial workflow initialization failed",
                initCompleted: "Workflow initialization completed",
                updating: "Updating status...",
                updateCompleted: "Update completed",
                updateFailed: "Update failed",
                viewDetails: "View details",
                historyTitle: "Build History",
                noHistory: "No history records",
                footer: "Data source: GitHub API | Refresh interval: 60s",
                status: {
                    queued: "Queued",
                    in_progress: "In progress",
                    completed: {
                        success: "Success",
                        failure: "Failure",
                        cancelled: "Cancelled",
                        neutral: "Neutral",
                        default: "Unknown"
                    },
                    no_runs: "No run records",
                    error: "Failed to fetch data",
                    unknown: "Unknown status"
                },
                time: {
                    justNow: "Just now",
                    minutesAgo: "{0} minutes ago",
                    hoursAgo: "{0} hours ago",
                    daysAgo: "{0} days ago"
                }
            }
        };

        // 当前语言
        let currentLang = 'zh';

        // 配置信息
        const config = {
            token: "{{API_GITHUB_TOKEN}}",
            interval: 180000,
            workflows: [
                { name: { zh: 'HelloWorld', en: 'HelloWorld' }, file: 'Build LEDE helloworld.yml', owner: 'game760', repo: 'openwrt' },
                { name: { zh: 'OpenClash', en: 'OpenClash' }, file: 'Build LEDE openclash.yml', owner: 'game760', repo: 'openwrt' },
                { name: { zh: 'PassWall', en: 'PassWall' }, file: 'Build LEDE passwall.yml', owner: 'game760', repo: 'openwrt' }, 
                { name: { zh: 'index', en: 'index' }, file: 'build-pages.yml', owner: 'game760', repo: 'openwrt' }
            ]
        };

        // 状态图标映射
        const statusIcons = {
            queued: { icon: 'fa-clock-o', color: 'pending' },
            in_progress: { icon: 'fa-spinner fa-spin', color: 'pending' },
            completed: {
                success: { icon: 'fa-check-circle', color: 'success' },
                failure: { icon: 'fa-times-circle', color: 'failure' },
                cancelled: { icon: 'fa-ban', color: 'cancelled' },
                neutral: { icon: 'fa-minus-circle', color: 'gray-500' },
                default: { icon: 'fa-question-circle', color: 'gray-400' }
            }
        };

        // 存储工作流ID映射
        const workflowIds = {};
        // 存储历史记录
        const history = [];

        // 初始化页面
        document.addEventListener('DOMContentLoaded', () => {
            // 绑定语言切换事件
            document.getElementById('lang-zh').addEventListener('click', () => setLanguage('zh'));
            document.getElementById('lang-en').addEventListener('click', () => setLanguage('en'));
            
            createWorkflowCards();
            
            if (!config.token) {
                alert('请先在代码中配置有效GitHub个人访问令牌(PAT)，需包含repo和workflow权限\nPlease configure a valid GitHub Personal Access Token (PAT) in the code first, which needs to include repo and workflow permissions');
            } else {
                fetchAllWorkflowIds();
                setInterval(fetchAllWorkflowStatuses, config.interval);
            }
        });

        // 设置语言
        function setLanguage(lang) {
            if (currentLang === lang) return;
            
            currentLang = lang;
            
            // 更新按钮状态
            document.getElementById('lang-zh').classList.toggle('active', lang === 'zh');
            document.getElementById('lang-en').classList.toggle('active', lang === 'en');
            
            // 更新静态文本
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                el.textContent = getI18n(currentLang, key);
            });
            
            // 更新工作流卡片
            updateAllWorkflowCards();
            
            // 更新历史记录
            renderHistory();
        }

        // 获取翻译文本
        function getI18n(lang, key, params = []) {
            const keys = key.split('.');
            let value = translations[lang];
            
            for (const k of keys) {
                if (value[k] === undefined) {
                    return key; // 如果找不到翻译，返回原始键
                }
                value = value[k];
            }
            
            // 替换参数
            if (typeof value === 'string' && params.length > 0) {
                return value.replace(/{(\d+)}/g, (match, index) => {
                    return params[index] !== undefined ? params[index] : match;
                });
            }
            
            return value;
        }

        // 创建工作流卡片（移除仓库标识和工作流文件路径）
        function createWorkflowCards() {
            const container = document.querySelector('.grid');
            config.workflows.forEach(workflow => {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow p-6 card-hover';
                card.id = `card-${workflow.owner}-${workflow.repo}-${workflow.file}`;
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-lg font-semibold workflow-name" 
                            data-workflow="${workflow.file}">${workflow.name[currentLang]}</h3>
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <i class="fa fa-question-circle text-2xl text-gray-400" 
                               id="icon-${workflow.owner}-${workflow.repo}-${workflow.file}"></i>
                            <span class="text-gray-600" 
                                  id="status-${workflow.owner}-${workflow.repo}-${workflow.file}">${getI18n(currentLang, 'waiting')}</span>
                        </div>
                        <span class="text-sm text-gray-500" 
                              id="time-${workflow.owner}-${workflow.repo}-${workflow.file}">-</span>
                    </div>
                    <div class="mt-4 pt-4 border-t border-gray-100 text-sm">
                        <a href="#" target="_blank" class="text-primary hover:underline flex items-center" 
                           id="link-${workflow.owner}-${workflow.repo}-${workflow.file}">
                            <i class="fa fa-external-link mr-1"></i> ${getI18n(currentLang, 'viewDetails')}
                        </a>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // 更新所有工作流卡片的语言
        function updateAllWorkflowCards() {
            config.workflows.forEach(workflow => {
                // 更新工作流名称
                document.querySelector(`.workflow-name[data-workflow="${workflow.file}"]`)
                    .textContent = workflow.name[currentLang];
                
                // 更新查看详情链接文本
                document.getElementById(`link-${workflow.owner}-${workflow.repo}-${workflow.file}`)
                    .innerHTML = `<i class="fa fa-external-link mr-1"></i> ${getI18n(currentLang, 'viewDetails')}`;
                
                // 如果已有状态数据，更新状态文本
                const statusElem = document.getElementById(`status-${workflow.owner}-${workflow.repo}-${workflow.file}`);
                const currentStatus = statusElem.getAttribute('data-status');
                const currentConclusion = statusElem.getAttribute('data-conclusion');
                
                if (currentStatus) {
                    let statusText;
                    if (currentStatus === 'completed' && currentConclusion) {
                        statusText = getI18n(currentLang, `status.completed.${currentConclusion}`);
                    } else {
                        statusText = getI18n(currentLang, `status.${currentStatus}`);
                    }
                    statusElem.textContent = statusText;
                }
                
                // 更新时间文本
                const timeElem = document.getElementById(`time-${workflow.owner}-${workflow.repo}-${workflow.file}`);
                const timestamp = timeElem.getAttribute('data-timestamp');
                if (timestamp) {
                    timeElem.textContent = formatRelativeTime(new Date(timestamp));
                }
            });
        }

        // 拉取所有仓库的工作流ID
        async function fetchAllWorkflowIds() {
            updateStatusIndicator(getI18n(currentLang, 'initializing'), 'text-pending');
            try {
                const fetchPromises = config.workflows.map(workflow => fetchSingleRepoWorkflowIds(workflow));
                await Promise.all(fetchPromises);

                const missingWfs = config.workflows.filter(workflow => {
                    const key = `${workflow.owner}-${workflow.repo}-${workflow.file}`;
                    return !workflowIds[key];
                });
                if (missingWfs.length > 0) {
                    const missingText = missingWfs.map(wf => `${wf.name[currentLang]}`).join(', ');
                    console.warn(`未找到以下工作流ID：${missingText}`);
                    updateStatusIndicator(getI18n(currentLang, 'partialInitFailed'), 'text-failure');
                } else {
                    updateStatusIndicator(getI18n(currentLang, 'initCompleted'), 'text-success');
                }

                fetchAllWorkflowStatuses();
            } catch (error) {
                console.error('工作流ID拉取失败：', error);
                updateStatusIndicator(getI18n(currentLang, 'initFailed'), 'text-failure');
            }
        }

        // 拉取单个仓库的工作流列表
        async function fetchSingleRepoWorkflowIds(workflow) {
            try {
                const response = await fetch(
                    `https://api.github.com/repos/${workflow.owner}/${workflow.repo}/actions/workflows`,
                    {
                        headers: {
                            'Accept': 'application/vnd.github.v3+json',
                            'Authorization': `token ${config.token}`
                        }
                    }
                );

                if (!response.ok) throw new Error(`HTTP ${response.status}（${workflow.owner}/${workflow.repo}）`);
                const data = await response.json();

                const targetWf = data.workflows.find(wf => wf.path.endsWith(workflow.file));
                if (targetWf) {
                    const key = `${workflow.owner}-${workflow.repo}-${workflow.file}`;
                    workflowIds[key] = targetWf.id;
                }
            } catch (error) {
                console.error(`仓库${workflow.owner}/${workflow.repo}工作流ID拉取失败：`, error);
            }
        }

        // 拉取所有工作流状态
        async function fetchAllWorkflowStatuses() {
            updateStatusIndicator(getI18n(currentLang, 'updating'), 'text-pending');
            try {
                const fetchPromises = config.workflows.map(workflow => fetchSingleWorkflowStatus(workflow));
                await Promise.all(fetchPromises);

                const now = new Date();
                document.getElementById('last-update').textContent = 
                    `${getI18n(currentLang, 'lastUpdate').split('：')[0]}：${now.toLocaleString()}`;
                updateStatusIndicator(getI18n(currentLang, 'updateCompleted'), 'text-success');
            } catch (error) {
                console.error('状态更新失败：', error);
                updateStatusIndicator(getI18n(currentLang, 'updateFailed'), 'text-failure');
            }
        }

        // 拉取单个工作流的最新状态
        async function fetchSingleWorkflowStatus(workflow) {
            const key = `${workflow.owner}-${workflow.repo}-${workflow.file}`;
            const wfId = workflowIds[key];

            if (!wfId) {
                updateWorkflowCard(workflow, { status: 'unknown', conclusion: 'unknown', updated_at: new Date().toISOString() });
                return;
            }

            try {
                const response = await fetch(
                    `https://api.github.com/repos/${workflow.owner}/${workflow.repo}/actions/workflows/${wfId}/runs?per_page=1`,
                    {
                        headers: {
                            'Accept': 'application/vnd.github.v3+json',
                            'Authorization': `token ${config.token}`
                        }
                    }
                );

                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();

                if (data.workflow_runs && data.workflow_runs.length > 0) {
                    const run = data.workflow_runs[0];
                    updateWorkflowCard(workflow, run);
                    addToHistory(workflow, run);
                } else {
                    updateWorkflowCard(workflow, { status: 'no_runs', conclusion: null, updated_at: null });
                }
            } catch (error) {
                console.error(`工作流${workflow.name[currentLang]}状态拉取失败：`, error);
                updateWorkflowCard(workflow, { status: 'error', conclusion: null, updated_at: new Date().toISOString() });
            }
        }

        // 更新工作流卡片
        function updateWorkflowCard(workflow, runData) {
            const key = `${workflow.owner}-${workflow.repo}-${workflow.file}`;
            const iconElem = document.getElementById(`icon-${key}`);
            const statusElem = document.getElementById(`status-${key}`);
            const timeElem = document.getElementById(`time-${key}`);
            const linkElem = document.getElementById(`link-${key}`);
            const cardElem = document.getElementById(`card-${key}`);

            // 保存状态数据用于语言切换时更新
            statusElem.setAttribute('data-status', runData.status);
            statusElem.setAttribute('data-conclusion', runData.conclusion || '');
            
            // 重置样式
            iconElem.className = '';
            statusElem.className = '';
            cardElem.classList.remove('border-l-4', 'border-pending', 'border-success', 'border-failure', 'border-cancelled');

            let statusInfo;
            let timeText = '-';
            let link = `https://github.com/${workflow.owner}/${workflow.repo}/actions/workflows/${workflow.file}`;

            if (runData.status === 'no_runs') {
                statusInfo = { 
                    icon: 'fa-file-text-o', 
                    color: 'gray-400', 
                    text: getI18n(currentLang, 'status.no_runs')
                };
            } else if (runData.status === 'error' || runData.status === 'unknown') {
                statusInfo = { 
                    icon: 'fa-exclamation-triangle', 
                    color: 'failure', 
                    text: getI18n(currentLang, 'status.error')
                };
            } else {
                // 处理时间 - 使用构建实际完成时间
                if (runData.updated_at) {
                    const buildTime = new Date(runData.updated_at);
                    timeText = formatRelativeTime(buildTime);
                    timeElem.setAttribute('data-timestamp', runData.updated_at);
                }
                
                if (runData.html_url) link = runData.html_url;
                
                // 处理状态
                if (runData.status === 'completed') {
                    const conclusion = runData.conclusion || 'default';
                    statusInfo = {
                        icon: statusIcons.completed[conclusion].icon,
                        color: statusIcons.completed[conclusion].color,
                        text: getI18n(currentLang, `status.completed.${conclusion}`)
                    };
                } else {
                    statusInfo = {
                        icon: statusIcons[runData.status].icon,
                        color: statusIcons[runData.status].color,
                        text: getI18n(currentLang, `status.${runData.status}`)
                    };
                }
                
                cardElem.classList.add('border-l-4', `border-${statusInfo.color}`);
            }

            // 更新UI
            iconElem.className = `fa ${statusInfo.icon} text-2xl text-${statusInfo.color}`;
            if (runData.status === 'in_progress') iconElem.classList.add('status-pulse');
            statusElem.className = `text-${statusInfo.color}`;
            statusElem.textContent = statusInfo.text;
            timeElem.textContent = timeText;
            linkElem.href = link;
        }

        // 添加到历史记录（移除仓库标识）
        function addToHistory(workflow, runData) {
            if (!runData.status || runData.status === 'no_runs' || runData.status === 'unknown') return;

            // 获取状态信息
            let statusInfo;
            if (runData.status === 'completed') {
                const conclusion = runData.conclusion || 'default';
                statusInfo = {
                    icon: statusIcons.completed[conclusion].icon,
                    color: statusIcons.completed[conclusion].color,
                    text: getI18n(currentLang, `status.completed.${conclusion}`),
                    key: `status.completed.${conclusion}`
                };
            } else {
                statusInfo = {
                    icon: statusIcons[runData.status].icon,
                    color: statusIcons[runData.status].color,
                    text: getI18n(currentLang, `status.${runData.status}`),
                    key: `status.${runData.status}`
                };
            }

            // 使用构建实际完成时间
            const buildTime = runData.updated_at ? new Date(runData.updated_at) : new Date();
            
            const historyItem = {
                timestamp: buildTime,
                workflow: workflow.name,
                status: statusInfo.text,
                statusKey: statusInfo.key,
                color: statusInfo.color,
                icon: statusInfo.icon
            };

            // 去重逻辑
            const lastItem = history.find(item => 
                item.workflow.zh === historyItem.workflow.zh
            );
            
            if (!(lastItem && lastItem.statusKey === historyItem.statusKey)) {
                history.unshift(historyItem);
                // 按时间排序
                history.sort((a, b) => b.timestamp - a.timestamp);
                if (history.length > 12) {
                    history.pop();
                }
                renderHistory();
            }
        }

        // 渲染历史记录（移除仓库标识）
        function renderHistory() {
            const container = document.getElementById('history-container');
            
            if (history.length === 0) {
                container.innerHTML = `<p class="text-gray-500 italic text-center py-4" data-i18n="noHistory">${getI18n(currentLang, 'noHistory')}</p>`;
                return;
            }

            container.innerHTML = '';
            history.forEach(item => {
                const entry = document.createElement('div');
                entry.className = 'flex flex-col sm:flex-row items-start sm:items-center justify-between py-2 border-b border-gray-100 last:border-0';
                entry.innerHTML = `
                    <div class="flex items-center space-x-3 mb-1 sm:mb-0">
                        <i class="fa ${item.icon} text-${item.color}"></i>
                        <div>
                            <span class="font-medium">${item.workflow[currentLang]}</span>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span class="text-${item.color} text-sm">${getI18n(currentLang, item.statusKey)}</span>
                        <span class="text-gray-500 text-xs">${item.timestamp.toLocaleString()}</span>
                    </div>
                `;
                container.appendChild(entry);
            });
        }

        // 更新状态指示器
        function updateStatusIndicator(text, className) {
            const indicator = document.getElementById('status-indicator');
            indicator.className = '';
            indicator.classList.add(...className.split(' '));
            indicator.textContent = text;
        }

        // 格式化相对时间（支持多语言）
        function formatRelativeTime(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);

            if (diffMins < 1) return getI18n(currentLang, 'time.justNow');
            if (diffMins < 60) return getI18n(currentLang, 'time.minutesAgo', [diffMins]);
            if (diffHours < 24) return getI18n(currentLang, 'time.hoursAgo', [diffHours]);
            return getI18n(currentLang, 'time.daysAgo', [diffDays]);
        }
    </script>
</body>
</html>